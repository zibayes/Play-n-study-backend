<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <!--	JQuery	-->

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <!-- MDB icon -->

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Google Fonts Roboto -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" />
  <!-- MDB -->
  <link rel="stylesheet" href="/static/css_mdb/mdb.min.css"/>
  <!-- Bootstrap CSS -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js" integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin="anonymous"></script>
  {% block title %}
  <title>Базовая страница профиля</title>
  {% endblock %}
  <!-- CSS	-->
<!--  <link href="css/main_base_aut.css" rel="stylesheet">-->
  {% block style %}
  {% endblock %}
</head>

<body style="background: #b4b4b4">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.1/emojionearea.min.css" />
<script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/emojionearea/3.4.1/emojionearea.min.js"></script>


{% block precontent %}
{% endblock %}


<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a href="/"><img src="/static/img/SFU_avatar.jpg" style="height: 25px" alt=""></a>
    <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarSupportedContent">
      <i class="fas fa-bars"></i>
    </button>
    <div class="d-flex align-items-center">
      <!-- Icon -->
      <div class="dropdown">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-mdb-toggle="dropdown" aria-expanded="false">
              <i class="flag-russia flag curflag m-0" key="flag"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              <li>
                <button id="ru" class="dropdown-item translate" href="#">
                  <i class="flag-russia flag"></i>
                  Русский
                  <i class="fa fa-check text-success ms-2" id="ru-tick" style="visibility: visible"></i>
                </button>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <button id="en" class="dropdown-item translate" href="#">
				<i class="flag-united-kingdom flag"></i>
				English
				<i class="fa fa-check text-success ms-2" id="en-tick" style="visibility: hidden"></i>
				</button>
              </li>
            </ul>
          </li>
        </ul>
      </div>

      <!-- Notifications -->
      <div class="dropdown" style="padding-left: 10px">
        <a class="text-reset me-3 dropdown-toggle hidden-arrow" href="#" id="navbarDropdownMenuLink" role="button" data-mdb-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-bell"></i>
          <span class="badge rounded-pill badge-notification bg-danger">1</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink">
          <li>
            <a class="dropdown-item" href="#">0</a>
          </li>
          <li>
            <a class="dropdown-item" href="#">1</a>
          </li>
          <li>
            <a class="dropdown-item" href="#">2</a>
          </li>
          <li>
            <a class="dropdown-item" href="#">3</a>
          </li>
          <li>
            <a class="dropdown-item" href="#">4</a>
          </li>
          <li>
            <a class="dropdown-item" href="#">5</a>
          </li>
        </ul>
      </div>
      <div style="padding: 10px">
        <a class="nav-link lang" href="#" key="support" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions"><i class="fas fa-paper-plane"></i></a>
      </div>

      <!-- Avatar -->
      <div class="dropdown" style="padding-left: 10px">
        <a class="dropdown-toggle d-flex align-items-center hidden-arrow" href="#" id="navbarDropdownMenuAvatar" role="button" data-mdb-toggle="dropdown" aria-expanded="false">
          <img src="/userava/{{current_user.get_id()}}" class="rounded-circle" height="35" width="35" loading="lazy" alt=""/>
        </a>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuAvatar">
          <li>
            <a class="dropdown-item lang" href="/" key="mainpage">Главная</a>
          </li>
          <li>
            <a class="dropdown-item lang" href="/profiles/{{current_user.get_id()}}" key="profile">Мой профиль</a>
          </li>
          <li>
            <a class="dropdown-item lang" href="/subscriptions/{{current_user.get_id()}}" key="friend">Мои подписки</a>
          </li>
          <li>
            <a class="dropdown-item lang" href="/courses/{{current_user.get_id()}}" key="subscriptions">Мои курсы</a>
          </li>
          <li>
            <a class="dropdown-item lang" href="/achievements/{{current_user.get_id()}}" key="achievements">Мои награды</a>
          </li>
          <li>
            <a class="dropdown-item lang" href="/settings" key="settings">Настройки</a>
          </li>
          <li>
            <a class="dropdown-item lang" href="/reviews" key="reviews">Отзывы</a>
          </li>
          <li>
            <a class="dropdown-item lang" href="/information" key="aboutus">О нас</a>
          </li>
          <li>
            <button class="dropdown-item lang" key="exit" data-mdb-toggle="modal" data-mdb-target="#exit"  aria-controls="pills-exit" aria-selected="false">Выйти</button>
          </li>
        </ul>
      </div>
    </div>
  </div>
</nav>
<div class="modal fade " id="exit" tabindex="-1">
  <div class="modal-dialog modal-side">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title lang" id="exampleModalLabel" key="confirmexit">Подтверждение выхода</h5>
        <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body lang" key="areusure">Вы точно хотите выйти?</div>
      <div class="modal-footer">
        <a type="button" class="btn badge-primary lang" key="logout" style="border-radius: 25px" href="/logout">Выход из учетной записи</a>
      </div>
    </div>
  </div>
</div>



<div style="background: gainsboro; width: 450px" class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasWithBothOptions" >
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">Ваши диалоги</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <hr style="color: black; margin: 0 0 0 0">
  <div class="offcanvas-body" id="chats">
    <!--  В этом диве помещаем чат  -->
    <div class="chats">
<!--      Конец элемента чат-->

      <!--      Конец элемента чат-->

    </div>
<!--    -->
  </div>
</div>


<div>
  {% block content %}
  {% endblock %}
</div>

<!-- MDB -->
<script type="text/javascript" src="/static/js_mdb/mdb.min.js"></script>

</body>

</html>
<style>
  .truncate-text {
    width: 350px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
<script>
    function update(chat_id, date_message) {

    }



    let div_main = document.getElementsByClassName('chats')[0]

    $.ajax({
      url: '/get_chats',
      method: 'post',
      dataType: 'json',
      success: function(json_data){
        console.log(json_data)
        json_data.chats.sort(
                function (a, b){
                  return new Date(b.time) - new Date(a.time)
                }
        )
        for (let i = 0; i < json_data.chats.length; i++){
          let div = add_element_chat(json_data.chats[i].chat_id, json_data.chats[i].time, json_data.chats[i].user_with, json_data.chats[i].from_who, json_data.chats[i].last_message, json_data.chats[i].checked, json_data.chats[i].user_with_id)
          div_main.appendChild(div)
        }
      }
    });



  function add_element_chat(chat_id, time, user_with, from_who, last_message, checked, user_with_id) {
    // 1 +
    let div_add = document.createElement("div")
    div_add.setAttribute("class", "collapse mt-3")
    div_add.id = "collapse" + chat_id
    // 2 +
    let div_card = document.createElement("div")
    div_card.setAttribute("class", "card")
    // 3 +
    let button_exit = document.createElement("button")
    button_exit.setAttribute("class", "btn-close")
    button_exit.setAttribute("type", "button")
    button_exit.setAttribute("data-mdb-toggle", "collapse")
    let href = "#collapse" + chat_id
    button_exit.setAttribute("href", href)
    button_exit.style = "padding: 10px"
    // 4
    let div_card_body = document.createElement("div")
    div_card_body.setAttribute("class", "card-body")
    div_card_body.setAttribute("data-mdb-perfect-scrollbar", "true")
    div_card_body.style = "position: relative; height: 400px; overflow: auto;"
    div_card_body.id = "div" + chat_id
    // 5
    // Элементы чата тут будут
    let date_message
    $.ajax({
              url: '/get_dialog',
              method: 'post',
              dataType: 'json',
              contentType: 'application/json',
              data: JSON.stringify({"chat_id": chat_id}),
              success: function (data) {
                date_message = data.messages[data.messages.length - 1].msg_date
                for (let i = 0; i < data.messages.length; i++) {
                  if (data.messages[i].msg_from === "Я: ") {
                    let div_element_d_flex = document.createElement("div")
                    div_element_d_flex.setAttribute("class", "d-flex flex-row justify-content-end mb-4 pt-1")
                    let div_element = document.createElement("div")
                    let flag = 0
                    for (let j = i; j < data.messages.length; j++) {
                      flag++
                      if (data.messages[j].msg_from === "Я: ") {
                        let p1 = document.createElement("p")
                        p1.setAttribute("class", "small p-2 me-3 mb-1 text-white rounded-3 bg-info")
                        p1.textContent = data.messages[j].msg_text
                        div_element.appendChild(p1)
                      } else {
                        i = i + flag - 2
                        break
                      }
                      if (j === data.messages.length - 1) {
                        i = data.messages.length
                        break
                      }
                    }
                    let image = document.createElement("img")
                    image.src = "https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava2-bg.webp"
                    image.alt = ""
                    image.style = "width: 45px; height: 100%;"
                    div_element_d_flex.appendChild(div_element)
                    div_element_d_flex.appendChild(image)
                    div_card_body.appendChild(div_element_d_flex)
                  } else {
                    let div_element_d_flex = document.createElement("div")
                    div_element_d_flex.setAttribute("class", "d-flex flex-row justify-content-start")
                    let image = document.createElement("img")
                    image.src = "https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava5-bg.webp"
                    image.alt = ""
                    image.style = "width: 45px; height: 100%;"
                    let div_element = document.createElement("div")
                    let flag = 0
                    for (let j = i; j < data.messages.length; j++) {
                      flag++
                      if (data.messages[j].msg_from !== "Я: ") {
                        let p1 = document.createElement("p")
                        p1.setAttribute("class", "small p-2 ms-3 mb-1 rounded-3")
                        p1.style = "background-color: #f5f6f7;"
                        p1.textContent = data.messages[j].msg_text
                        div_element.appendChild(p1)
                      } else {
                        i = i + flag - 2
                        break
                      }
                      if (j === data.messages.length - 1) {
                        i = data.messages.length
                        break
                      }
                    }
                    div_element_d_flex.appendChild(image)
                    div_element_d_flex.appendChild(div_element)
                    div_card_body.appendChild(div_element_d_flex)

                  }
                }
              }
            }
    );


    // 6
    let div_container = document.createElement("div")
    div_container.setAttribute("class", "container")
    // 7
    let div_row = document.createElement("div")
    div_row.setAttribute("class", "row card-footer text-muted align-items-center")
    // 8
    let div_column1 = document.createElement("div")
    div_column1.setAttribute("class", "col-md-10")
    // 9
    let textarea = document.createElement("textarea")
    textarea.id = "textarea" + chat_id
    textarea.setAttribute("class", "shoutbox-name form-control form-control-lg")
    textarea.setAttribute("type", "text")
    textarea.setAttribute("placeholder", "Введите сообщение")
    // 10
    let div_column2 = document.createElement("div")
    div_column2.setAttribute("class", "col-md-1")
    div_column2.style = "padding: 0 0 0 10px"
    // 11
    let a1 = document.createElement("a")
    a1.setAttribute("class", "ms-1 text-muted")
    a1.setAttribute("href", "#!")
    // 12
    let i1 = document.createElement("i")
    i1.setAttribute("class", "fas fa-paperclip")
    // 13
    let div_column3 = document.createElement("div")
    div_column3.setAttribute("class", "col-md-1")
    // 14
    let a2 = document.createElement("a")
    a2.setAttribute("class", "ms-3 link-info")
    a2.setAttribute("href", "#!")
    a2.addEventListener("click", function () {
      var input = document.getElementById("textarea" + chat_id)
      if (input.value !== ""){
        $.ajax({
          url: '/send_message',
          method: 'post',
          dataType: 'html',
          contentType:'application/json',
          data: JSON.stringify({"msg_text": input.value, "msg_to": user_with_id}),
          success: function(data){
            input.value = ""
          }
        });
      }
    })
    setInterval(function () {
      $.ajax({
        url: '/get_dialog',
        method: 'post',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({"chat_id": chat_id}),
        success: function (data) {
          if(new Date(data.messages[data.messages.length - 1].msg_date) > new Date(date_message)){
              // Собеседник
              var div_card_element = document.getElementById("div" + chat_id)
              let div_element_d_flex = document.createElement("div")
              div_element_d_flex.setAttribute("class", "d-flex flex-row justify-content-end mb-4 pt-1")
              let div_element = document.createElement("div")
              let image = document.createElement("img")
              image.src = "https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava2-bg.webp"
              image.alt = ""
              image.style = "width: 45px; height: 100%;"
              let p1 = document.createElement("p")
              p1.setAttribute("class", "small p-2 me-3 mb-1 text-white rounded-3 bg-info")
              p1.textContent = data.messages[data.messages.length - 1].msg_text
              div_element.appendChild(p1)
              div_element_d_flex.appendChild(div_element)
              div_element_d_flex.appendChild(image)
              div_card_element.appendChild(div_element_d_flex)
              date_message = data.messages[data.messages.length - 1].msg_date
          }
        }
      })
      console.log(date_message)
    }, 500)
    // 15
    let i2 = document.createElement("i")
    i2.setAttribute("class", "fas fa-paper-plane")
    // Соединяем элементы
    a2.appendChild(i2)
    div_column3.appendChild(a2)
    a1.appendChild(i1)
    div_column2.appendChild(a1)
    div_column1.appendChild(textarea)
    div_row.appendChild(div_column1)
    div_row.appendChild(div_column2)
    div_row.appendChild(div_column3)
    div_container.appendChild(div_row)
    div_card.appendChild(button_exit)
    div_card.appendChild(div_card_body)
    div_card.appendChild(div_container)
    div_add.appendChild(div_card) // !
    // 16!
    let br = document.createElement("br")
    // 17
    let a = document.createElement("a")

    a.setAttribute("data-mdb-toggle", "collapse")
    a.setAttribute("href", href)
    a.setAttribute("role", "button")
    a.setAttribute("aria-expanded", "false")
    // 18
    let div_card_body2 = document.createElement("div")
    div_card_body2.setAttribute("class", "card-body")
    // 19
    let div_card_pos = document.createElement("div")
    div_card_pos.setAttribute("class", "position-relative position-relative-example")
    // 20
    let div_card_pos_1 = document.createElement("div")
    div_card_pos_1.setAttribute("class", "position-absolute top-0 end-0 text-muted")
    let time_correct = new Date(time)
    let today = new Intl.DateTimeFormat('ru', {weekday: 'long'}).format(time_correct);
    let seconds = ""
    if (time_correct.getSeconds() < 10){
      seconds = "0" + time_correct.getSeconds()
    }
    else{
      seconds = time_correct.getSeconds()
    }
    div_card_pos_1.textContent = today + " " + time_correct.getHours() + ":" + seconds
    div_card_pos_1.style = "font-size: 75%"
    // 21 Уведомление!
    let div_card_pos_2 = document.createElement("div")
    if (checked === true){
      a.setAttribute("class", "card elements opacity-75")
    }else{
      a.setAttribute("class", "card elements")
      div_card_pos_2.setAttribute("class", "position-absolute top-0 start-50 text-warning")
      div_card_pos_2.textContent = "Уведомление!"
      div_card_pos_2.style = "font-size: 75%"
    }
    // 22
    let div_container2 = document.createElement("div")
    div_container2.setAttribute("class", "container")
    // 23
    let div_row2 = document.createElement("div")
    div_row2.setAttribute("class", "row")
    // 24
    let div_col1 = document.createElement("div")
    div_col1.setAttribute("class", "col-md-2")
    div_col1.style = "padding: 10px 0 10px 0"
    // 25
    let img = document.createElement("img")
    img.setAttribute("src", "https://blog.getbootstrap.com/assets/img/2022/05/docs-home.png")
    img.setAttribute("alt", "")
    img.setAttribute("class", "rounded-circle")
    img.style = "width: 45px; height: 45px"
    // 26
    let div_col2 = document.createElement("div")
    div_col2.setAttribute("class", "col-md-10")
    div_col2.style = "padding: 10px 0 0 10px"
    // 27
    let p1 = document.createElement("p")
    p1.setAttribute("class", "fw-bold mb-1 lang text-muted")
    p1.textContent = user_with
    // 28
    let div_flex = document.createElement("div")
    div_flex.setAttribute("class", "d-flex")
    // 29
    let span = document.createElement("div")
    span.setAttribute("class", "text-muted lang fw-bold")
    span.style = "font-size: 75%"
    span.textContent = from_who + ":"
    // 30
    let p2 = document.createElement("p")
    p2.setAttribute("class", "lang text-muted text-truncate")
    p2.style = "font-size: 75%"
    p2.textContent = last_message
    // Соединяем
    div_col2.appendChild(p1)
    div_flex.appendChild(span)
    div_flex.appendChild(p2)
    div_col2.appendChild(div_flex)
    div_col1.appendChild(img)
    div_row2.appendChild(div_col1)
    div_row2.appendChild(div_col2)
    div_container2.appendChild(div_row2)
    div_card_pos.appendChild(div_card_pos_1)
    div_card_pos.appendChild(div_card_pos_2)
    div_card_body2.appendChild(div_card_pos)
    div_card_body2.appendChild(div_container2)
    a.appendChild(div_card_body2) // !
    let div_main = document.createElement("div")
    div_main.appendChild(div_add)
    div_main.appendChild(br)
    div_main.appendChild(a)
    return div_main
  }




    $('.shoutbox-name').emojioneArea({
      emojiPlaceholder: ":smile_cat:",
      searchPlaceholder: "Поиск",
      buttonTitle: "Эмодзи",
      searchPosition: "top",
      pickerPosition: "top"
    });


var arrLang = {
  'en': {
    'mainpage': 'Main page',
    'support': 'Support',
    'profile': 'My profile',
    'achievements': 'My achievements',
    'timetable': 'My timetable',
    'settings': 'Settings',
    'reviews': 'Reviews',
    'aboutus': 'About us',
    'exit': 'Logout',
    'areusure': 'Are you sure you want to log out?',
    'confirmexit': 'Confirm logout',
    'logout': 'Log out of your account',
    'flag': 'flag-united-kingdom',

    'createform': 'Create form',
    'form': 'Form',

    'maininfo': 'Main information',
    'changeava': 'Change avatar',
    'anachievements': 'Achievements',
    'name': 'Name',
    'surname': 'Surname',
    'phonenumber': 'Phone number',
    'email': 'Email',
    'city': 'City',
    'university': 'University',
    'specialization': 'Specialization',
    'group': 'Group',
    'save': 'Save',

    'devteam': 'Development team',
    'pavel': 'Pavel',
    'pavinfo': 'Backend and frontend developer',
    'online': 'Online',
    'ilya': 'Ilya',
    'ilyinfo': 'Frontend developer',
    'offline': 'Offline',
    'anton': 'Anton',
    'antinfo': 'Backend developer',
    'afk': 'AFK',
    'devinfo': 'Information about developer',
  },
  'ru': {
    'mainpage': 'Главная',
    'support': 'Поддержка',
    'profile': 'Мой профиль',
    'achievements': 'Мои награды',
    'timetable': 'Мое расписание',
    'settings': 'Настройки',
    'reviews': 'Отзывы',
    'aboutus': 'О нас',
    'exit': 'Выйти',
    'areusure': 'Вы точно хотите выйти?',
    'confirmexit': 'Подтверждение выхода',
    'logout': 'Выход из учетной записи',
    'flag': 'flag-russia',

    'createform': 'Создание формы',
    'form': 'Форма',

    'maininfo': 'Основная информация',
    'changeava': 'Сменить аватар',
    'anachievements': 'Достижения',
    'name': 'Имя',
    'surname': 'Фамилия',
    'phonenumber': 'Номер телефона',
    'email': 'Электронная почта',
    'city': 'Город',
    'university': 'Институт',
    'specialization': 'Специальность',
    'group': 'Учебная группа',
    'save': 'Сохранить',

    'devteam': 'Команда разработчиков',
    'pavel': 'Павел',
    'pavinfo': 'Бэкенд и Фронтенд разработчик',
    'online': 'На сайте',
    'ilya': 'Илья',
    'ilyinfo': 'Фронтэнд разработчик',
    'offline': 'Оффлайн',
    'anton': 'Антон',
    'antinfo': 'Бэкенд разработчик',
    'afk': 'Спит',
    'devinfo': 'Информация о разработчике',
  }
}

  $(function() {
    $('.translate').click(function() {
      var lang = $(this).attr('id');
      $('.lang').each(function(index, item) {
        $(this).text(arrLang[lang][$(this).attr('key')]);
		$('.curflag').removeClass('flag-united-kingdom').removeClass('flag-russia').addClass(arrLang[lang][$('.curflag').attr('key')]);
      });
	  let vis = document.getElementById("ru-tick").style.visibility;
		if (vis.valueOf() == "visible".valueOf()){
			document.getElementById("ru-tick").style.visibility = "hidden";
			document.getElementById("en-tick").style.visibility = "visible";
			localStorage.setItem('language', 'en')
		} else {
			document.getElementById("ru-tick").style.visibility = "visible";
			document.getElementById("en-tick").style.visibility = "hidden";
			localStorage.setItem('language', 'ru')
		}
    });
  });
  







</script>
{% block script %}
{% endblock %}